<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>FF14 å®‡å®™æ¢ç´¢è¿›åº¦</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;margin:0;padding:0;background:#f5f5f5;color:#333}
    h1{text-align:center;margin:16px 0}
    .bar{height:18px;background:#e0e0e0;border-radius:4px;overflow:hidden}
    .bar-inner{height:100%;background:linear-gradient(90deg,#4caf50 0%,#8bc34a 100%);transition:width .3s}
    table{width:96%;margin:0 auto;border-collapse:collapse;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    th,td{padding:8px 12px;text-align:left;font-size:14px}
    th{background:#fafafa;cursor:pointer;user-select:none}
    tr:nth-child(even){background:#fafafa}
    input[type=search],.filter-row{width:96%;max-width:480px;margin:8px auto;display:block;padding:8px 12px;font-size:14px;border:1px solid #bbb;border-radius:4px}
    .filter-row{display:flex;gap:8px}
    select{flex:1;padding:6px 8px;font-size:14px;border:1px solid #ccc;border-radius:4px}
  </style>
</head>
<body>
<h1>FF14 å®‡å®™æ¢ç´¢è¿›åº¦</h1>

<!-- æœç´¢æ¡† -->
<input id="search" type="search" placeholder="ğŸ” æœç´¢æœåŠ¡å™¨ / å¤§åŒº / æ•°æ®ä¸­å¿ƒ">

<!-- ä¸‰çº§ä¸‹æ‹‰ -->
<div class="filter-row">
  <select id="selRegion"><option value="">å…¨éƒ¨å¤§åŒº</option></select>
  <select id="selDC"><option value="">å…¨éƒ¨æ•°æ®ä¸­å¿ƒ</option></select>
  <select id="selServer"><option value="">å…¨éƒ¨æœåŠ¡å™¨</option></select>
</div>

<table id="table">
  <thead>
    <tr>
      <th data-key="region">å¤§åŒº</th>
      <th data-key="dc">æ•°æ®ä¸­å¿ƒ</th>
      <th data-key="server">æœåŠ¡å™¨</th>
      <th data-key="progress">è¿›åº¦</th>
      <th data-key="level">ç­‰çº§</th>
      <th data-key="lastUpdate">æ›´æ–°æ—¶é—´</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
/* ========== é…ç½® ========== */
const DATA_URL = 'data.json';
const REFRESH  = 5 * 60 * 1000;
let raw = [], sortKey = 'progress', asc = false;

/* ========== å·¥å…·å‡½æ•° ========== */
const $ = id => document.getElementById(id);
async function fetchData(){
  try{
    const res = await fetch(DATA_URL);
    raw = await res.json();
    initSelect();
    render();
  }catch(e){ console.error(e); }
}

/* ========== ä¸‰çº§ä¸‹æ‹‰åˆå§‹åŒ– ========== */
const selR = $('selRegion'), selD = $('selDC'), selS = $('selServer');
function initSelect(){
  const regionSet = new Set(), dcSet = new Set(), serverSet = new Set();
  raw.forEach(it => {
    regionSet.add(it.region);
    if(it.dc) dcSet.add(it.dc);
    serverSet.add(it.server);
  });
  selR.innerHTML = '<option value="">å…¨éƒ¨å¤§åŒº</option>' + [...regionSet].sort().map(r => `<option value="${r}">${r}</option>`).join('');
  selD.innerHTML = '<option value="">å…¨éƒ¨æ•°æ®ä¸­å¿ƒ</option>' + [...dcSet].sort().map(d => `<option value="${d}">${d}</option>`).join('');
  selS.innerHTML = '<option value="">å…¨éƒ¨æœåŠ¡å™¨</option>' + [...serverSet].sort().map(s => `<option value="${s}">${s}</option>`).join('');
}

/* ========== æ¸²æŸ“ + ç­›é€‰ ========== */
function render(){
  const kw = $('search').value.trim().toLowerCase();
  const r = selR.value, d = selD.value, s = selS.value;
  const tbody = document.querySelector('#table tbody');
  tbody.innerHTML = '';

  const list = raw
    .filter(it =>
      (!r || it.region === r) &&
      (!d || (it.dc || '') === d) &&
      (!s || it.server === s) &&
      (!kw || `${it.region}${it.dc||''}${it.server}`.toLowerCase().includes(kw))
    )
    .sort((a,b)=>(asc?a[sortKey]>b[sortKey]:a[sortKey]<b[sortKey])?-1:1);

  list.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.region}</td>
      <td>${it.dc||'-'}</td>
      <td>${it.server}</td>
      <td>
        <div class="bar" title="${it.progress}%">
          <div class="bar-inner" style="width:${it.progress}%"></div>
        </div>
        <span>${it.progress}%</span>
      </td>
      <td>${it.level}</td>
      <td>${it.lastUpdate}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========== äº‹ä»¶ç»‘å®š ========== */
$('search').addEventListener('input', render);
selR.addEventListener('change', render);
selD.addEventListener('change', render);
selS.addEventListener('change', render);
document.querySelectorAll('th[data-key]').forEach(th=>{
  th.addEventListener('click',()=>{
    const k = th.dataset.key;
    if(sortKey === k) asc = !asc;
    else { sortKey = k; asc = false; }
    render();
  });
});

/* ========== å¯åŠ¨ ========== */
fetchData();
setInterval(fetchData, REFRESH);
</script>
</body>
</html>
