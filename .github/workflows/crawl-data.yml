name: 爬取FFXIV宇宙探索数据
on:
  schedule:
    - cron: '*/30 * * * *'  # 每30分钟执行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  crawl:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 显式授予写入权限（关键修复）
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: main  # 明确指定检出main分支

      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 安装依赖
        run: |
          mkdir -p scripts
          npm init -y --prefix scripts
          npm install axios cheerio moment --prefix scripts

      - name: 执行爬取脚本
        run: |
          node ./scripts/crawl.js
          # 调试：打印生成的文件列表（确认文件是否真的生成）
          echo "生成的数据文件："
          ls -l data/history/ || echo "无文件生成"

      - name: 提交数据更新
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 强制创建目录并确保权限
          mkdir -p data/history
          chmod -R 755 data/history
          touch data/history/.gitkeep
          
          # 显式添加所有文件（包括新创建的）
          git add data/history/
          
          # 调试：检查暂存区状态
          echo "暂存区状态："
          git status
          
          # 提交逻辑
          if git diff --cached --quiet; then
            echo "无数据更新，不提交"
          else
            git commit -m "自动更新数据: $(date +'%Y-%m-%d %H:%M:%S')"
            # 强制推送（解决可能的分支冲突）
            git push origin main --force-with-lease
          fi
      - name: 提交 public/data.json 更新（网页实时用）
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add public/data.json
          # 有变化才提交，避免空 commit
          git diff --cached --quiet || (git commit -m "auto: update public/data.json" && git push origin main --force-with-lease)
